<div class="container mt-4">
  <div class="row mb-4">
    <div class="col">
      <h1 class="h3">ðŸ§ª Webhook Sandbox</h1>
      <p class="text-muted">Test webhook payloads in dry-run mode â€” no database changes, no action execution.</p>
    </div>
  </div>

  <% if @providers.empty? %>
    <div class="alert alert-info text-center">
      <p class="mb-3">No active providers configured.</p>
      <%= link_to "Create a Provider", new_admin_provider_path, class: "btn btn-primary" %>
    </div>
  <% else %>
    <div class="card shadow-sm">
      <div class="card-body">
        <form id="sandbox-form">
          <!-- Provider Selection -->
          <div class="mb-3">
            <label for="provider-select" class="form-label">Provider</label>
            <select id="provider-select" class="form-select">
              <option value="">Select a provider...</option>
              <% @providers.each do |provider| %>
                <option value="<%= provider.id %>"><%= provider.display_name || provider.name %></option>
              <% end %>
            </select>
          </div>

          <!-- Payload Editor -->
          <div class="mb-3">
            <label for="payload-input" class="form-label">
              JSON Payload
              <small class="text-muted ms-2">ðŸ’¡ Change "type" to match your action event types</small>
            </label>
            <textarea 
              id="payload-input" 
              class="form-control font-monospace" 
              rows="12" 
              style="font-size: 0.875rem;"
              placeholder='{"type": "test", "data": {...}}'
            >{"type": "test","id": "test-<%= SecureRandom.hex(8) %>","timestamp": <%= Time.now.to_i %>,"data": {"message": "Hello from sandbox!","user_id": 12345}}</textarea>
          </div>

          <!-- Test Button -->
          <div class="d-grid">
            <button type="button" id="test-webhook-btn" class="btn btn-primary btn-lg">
              <span id="btn-text">Test Payload (Dry Run)</span>
              <span id="btn-spinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status">
                <span class="visually-hidden">Loading...</span>
              </span>
            </button>
          </div>
        </form>

        <!-- Results Section -->
        <div id="result-container" class="mt-4 d-none">
          <hr>
          <h5>Result</h5>
          <pre id="result-content" class="bg-dark text-light p-3 rounded" style="font-size: 0.75rem; max-height: 400px; overflow: auto;"></pre>
        </div>
      </div>
    </div>

    <!-- Info Alert -->
    <div class="alert alert-info mt-4">
      <h6 class="alert-heading">About Dry Run Mode</h6>
      <div class="row">
        <div class="col-md-6">
          <strong>This will:</strong>
          <ul class="mb-0 mt-2">
            <li>Validate JSON format</li>
            <li>Show matching actions</li>
            <li>Extract event metadata</li>
          </ul>
        </div>
        <div class="col-md-6">
          <strong>This will NOT:</strong>
          <ul class="mb-0 mt-2">
            <li>Create database records</li>
            <li>Execute action logic</li>
            <li>Enqueue background jobs</li>
          </ul>
        </div>
      </div>
    </div>
  <% end %>
</div>

<script>
(function() {
  const providerSelect = document.getElementById('provider-select');
  const payloadInput = document.getElementById('payload-input');
  const testBtn = document.getElementById('test-webhook-btn');
  const btnText = document.getElementById('btn-text');
  const btnSpinner = document.getElementById('btn-spinner');
  const resultContainer = document.getElementById('result-container');
  const resultContent = document.getElementById('result-content');

  testBtn.addEventListener('click', async function() {
    const providerId = providerSelect.value;
    const payload = payloadInput.value;

    if (!providerId) {
      alert('Please select a provider');
      return;
    }

    testBtn.disabled = true;
    btnText.textContent = 'Testing...';
    btnSpinner.classList.remove('d-none');
    resultContainer.classList.add('d-none');

    try {
      const response = await fetch('/captain_hook/admin/sandbox/test', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({
          provider_id: providerId,
          payload: payload
        })
      });

      const data = await response.json();
      resultContainer.classList.remove('d-none');
      resultContent.textContent = JSON.stringify(data, null, 2);
    } catch (error) {
      resultContainer.classList.remove('d-none');
      resultContent.textContent = `Error: ${error.message}`;
    } finally {
      testBtn.disabled = false;
      btnText.textContent = 'Test Payload (Dry Run)';
      btnSpinner.classList.add('d-none');
    }
  });
})();
</script>
