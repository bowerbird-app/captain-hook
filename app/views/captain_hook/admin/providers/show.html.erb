<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <nav aria-label="breadcrumb" class="mb-6">
    <ol class="flex items-center space-x-2 text-sm">
      <li>
        <%= link_to "Providers", admin_providers_path, class: "text-gray-600 hover:text-gray-900 hover:underline" %>
      </li>
      <li class="text-gray-400">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
      </li>
      <li class="font-medium text-gray-900">
        <%= @registry_config&.display_name || @provider.name.titleize %>
      </li>
    </ol>
  </nav>

  <div class="flex justify-between items-center mb-4">
    <h1 class="text-3xl font-bold"><%= @registry_config&.display_name || @provider.name.titleize %></h1>
    <div>
      <%= render FlatPack::Button::Component.new(
        text: "View Actions",
        url: admin_provider_actions_path(@provider),
        style: :secondary
      ) %>
    </div>
  </div>

  <!-- Status Badge -->
  <div class="mb-6">
    <% if @provider.active? %>
      <%= render FlatPack::Badge::Component.new(text: "Active", variant: :success, size: :md) %>
    <% else %>
      <%= render FlatPack::Badge::Component.new(text: "Inactive", variant: :default, size: :md) %>
    <% end %>
  </div>

  <!-- Webhook URL Card -->
  <div class="bg-white shadow rounded-lg mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900">Webhook Endpoint</h2>
    </div>
    <div class="px-6 py-4">
      <p class="text-gray-600 mb-3">Share this URL with <%= @registry_config&.display_name || @provider.name.titleize %> to receive webhooks:</p>
      <div class="flex gap-2 items-start" data-controller="webhook-copy">
        <div class="flex-1">
          <input 
            type="text"
            value="<%= @provider.webhook_url(base_url: "#{request.protocol}#{request.host_with_port}") %>"
            readonly
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 text-gray-700 font-mono text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            data-webhook-copy-target="input"
          />
        </div>
        <%= render FlatPack::Button::Component.new(
          text: "üìã Copy",
          style: :primary,
          data: { action: "click->webhook-copy#copy" }
        ) %>
      </div>
      <p class="text-sm text-gray-500 mt-3">
        This URL is unique to this provider and includes a secure token for authentication.
      </p>
    </div>
  </div>

  <!-- Provider Details -->
  <div class="bg-white shadow rounded-lg mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900">Provider Details</h2>
    </div>
    <div class="px-6 py-4">
      <dl class="grid grid-cols-1 gap-4">
        <div class="grid grid-cols-3 gap-4">
          <dt class="text-sm font-medium text-gray-500">Name</dt>
          <dd class="col-span-2 text-sm text-gray-900"><code class="px-2 py-1 bg-gray-100 rounded"><%= @provider.name %></code></dd>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <dt class="text-sm font-medium text-gray-500">Display Name</dt>
          <dd class="col-span-2 text-sm text-gray-900">
            <% if @registry_config&.display_name.present? %>
              <%= @registry_config.display_name %>
            <% else %>
              ‚Äî
            <% end %>
          </dd>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <dt class="text-sm font-medium text-gray-500">Description</dt>
          <dd class="col-span-2 text-sm text-gray-900">
            <% if @registry_config&.description.present? %>
              <%= @registry_config.description %>
            <% else %>
              ‚Äî
            <% end %>
          </dd>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <dt class="text-sm font-medium text-gray-500">Verifier File</dt>
          <dd class="col-span-2 text-sm text-gray-900">
            <% if @registry_config&.verifier_file.present? %>
              <code class="px-2 py-1 bg-gray-100 rounded"><%= @registry_config.verifier_file %></code>
            <% else %>
              ‚Äî
            <% end %>
          </dd>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <dt class="text-sm font-medium text-gray-500">Signing Secret</dt>
          <dd class="col-span-2 text-sm text-gray-900">
            <% if @registry_config&.signing_secret.present? %>
              <%= render FlatPack::Badge::Component.new(text: "Configured", variant: :success, size: :sm) %>
            <% else %>
              <%= render FlatPack::Badge::Component.new(text: "Not Set", variant: :default, size: :sm) %>
              <div class="text-sm text-gray-500 mt-1">
                ‚ö†Ô∏è Some providers don't require a signing secret, but if this provider supports webhook signature verification, you should configure one for security.
              </div>
            <% end %>
          </dd>
        </div>
      </dl>
    </div>
  </div>

  <!-- Security Settings -->
  <!-- Configuration hierarchy: captain_hook.yml providers ‚Üí provider.yml ‚Üí captain_hook.yml defaults ‚Üí hardcoded -->
  <div class="bg-white shadow rounded-lg mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900">Security Settings</h2>
    </div>
    <div class="px-6 py-4">
      <dl class="grid grid-cols-1 gap-4">
        <% 
          # Get values from different sources
          provider_name = @provider.name
          
          # timestamp_tolerance_seconds
          global_override_timestamp = @global_config&.dig("providers", provider_name, "timestamp_tolerance_seconds")
          provider_yaml_timestamp = @provider_yaml&.dig("timestamp_tolerance_seconds")
          global_default_timestamp = @global_config&.dig("defaults", "timestamp_tolerance_seconds")
          hardcoded_timestamp = 300
          
          final_timestamp = global_override_timestamp || provider_yaml_timestamp || global_default_timestamp || hardcoded_timestamp
          
          # max_payload_size_bytes
          global_override_size = @global_config&.dig("providers", provider_name, "max_payload_size_bytes")
          provider_yaml_size = @provider_yaml&.dig("max_payload_size_bytes")
          global_default_size = @global_config&.dig("defaults", "max_payload_size_bytes")
          hardcoded_size = 1_048_576
          
          final_size = global_override_size || provider_yaml_size || global_default_size || hardcoded_size
          
          # rate_limit_requests
          db_rate_requests = @provider.rate_limit_requests
          provider_yaml_rate_requests = @provider_yaml&.dig("rate_limit_requests")
          hardcoded_rate_requests = 100
          
          final_rate_requests = db_rate_requests || provider_yaml_rate_requests || hardcoded_rate_requests
          
          # rate_limit_period
          db_rate_period = @provider.rate_limit_period
          provider_yaml_rate_period = @provider_yaml&.dig("rate_limit_period")
          hardcoded_rate_period = 60
          
          final_rate_period = db_rate_period || provider_yaml_rate_period || hardcoded_rate_period
        %>
        
        <div class="grid grid-cols-3 gap-4">
          <dt class="text-sm font-medium text-gray-500">timestamp_tolerance_seconds</dt>
          <dd class="col-span-2 text-sm text-gray-900">
            <%= final_timestamp %>
            <% if global_override_timestamp %>
              <%= render FlatPack::Badge::Component.new(text: "captain_hook.yml providers", variant: :success, size: :sm, class: "ml-2") %>
            <% elsif provider_yaml_timestamp %>
              <%= render FlatPack::Badge::Component.new(text: "#{provider_name}.yml", variant: :info, size: :sm, class: "ml-2") %>
            <% elsif global_default_timestamp %>
              <%= render FlatPack::Badge::Component.new(text: "captain_hook.yml defaults", variant: :default, size: :sm, class: "ml-2") %>
            <% else %>
              <%= render FlatPack::Badge::Component.new(text: "hardcoded", variant: :default, size: :sm, class: "ml-2") %>
            <% end %>
            <span class="text-gray-500">(¬±<%= final_timestamp %>s tolerance)</span>
          </dd>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <dt class="text-sm font-medium text-gray-500">max_payload_size_bytes</dt>
          <dd class="col-span-2 text-sm text-gray-900">
            <%= number_with_delimiter(final_size) %>
            <% if global_override_size %>
              <%= render FlatPack::Badge::Component.new(text: "captain_hook.yml providers", variant: :success, size: :sm, class: "ml-2") %>
            <% elsif provider_yaml_size %>
              <%= render FlatPack::Badge::Component.new(text: "#{provider_name}.yml", variant: :info, size: :sm, class: "ml-2") %>
            <% elsif global_default_size %>
              <%= render FlatPack::Badge::Component.new(text: "captain_hook.yml defaults", variant: :default, size: :sm, class: "ml-2") %>
            <% else %>
              <%= render FlatPack::Badge::Component.new(text: "hardcoded", variant: :default, size: :sm, class: "ml-2") %>
            <% end %>
            <span class="text-gray-500">(<%= number_to_human_size(final_size) %>)</span>
          </dd>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <dt class="text-sm font-medium text-gray-500">rate_limit_requests</dt>
          <dd class="col-span-2 text-sm text-gray-900">
            <%= final_rate_requests %>
            <% if db_rate_requests %>
              <%= render FlatPack::Badge::Component.new(text: "database", variant: :warning, size: :sm, class: "ml-2") %>
            <% elsif provider_yaml_rate_requests %>
              <%= render FlatPack::Badge::Component.new(text: "#{provider_name}.yml", variant: :info, size: :sm, class: "ml-2") %>
            <% else %>
              <%= render FlatPack::Badge::Component.new(text: "hardcoded", variant: :default, size: :sm, class: "ml-2") %>
            <% end %>
            <span class="text-gray-500">(requests)</span>
          </dd>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <dt class="text-sm font-medium text-gray-500">rate_limit_period</dt>
          <dd class="col-span-2 text-sm text-gray-900">
            <%= final_rate_period %>
            <% if db_rate_period %>
              <%= render FlatPack::Badge::Component.new(text: "database", variant: :warning, size: :sm, class: "ml-2") %>
            <% elsif provider_yaml_rate_period %>
              <%= render FlatPack::Badge::Component.new(text: "#{provider_name}.yml", variant: :info, size: :sm, class: "ml-2") %>
            <% else %>
              <%= render FlatPack::Badge::Component.new(text: "hardcoded", variant: :default, size: :sm, class: "ml-2") %>
            <% end %>
            <span class="text-gray-500">(seconds)</span>
          </dd>
        </div>
      </dl>
    </div>
  </div>

  <!-- Recent Events -->
  <div class="bg-white shadow rounded-lg">
    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
      <h2 class="text-lg font-semibold text-gray-900">Recent Events</h2>
      <%= render FlatPack::Button::Component.new(
        text: "View All",
        url: admin_incoming_events_path(provider: @provider.name),
        style: :secondary,
        size: :sm
      ) %>
    </div>
    <div class="px-6 py-4">
      <% if @recent_events.any? %>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead>
              <tr>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event Type</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Received</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <% @recent_events.each do |event| %>
                <%
                  status_variant = case event.status&.to_s
                  when "pending" then :warning
                  when "processing" then :info
                  when "completed", "sent" then :success
                  when "failed" then :warning
                  else :default
                  end
                %>
                <tr>
                  <td class="px-3 py-4 whitespace-nowrap text-sm"><code class="px-2 py-1 bg-gray-100 rounded text-xs"><%= event.event_type %></code></td>
                  <td class="px-3 py-4 whitespace-nowrap text-sm">
                    <%= render FlatPack::Badge::Component.new(text: event.status&.titleize || 'N/A', variant: status_variant, size: :sm) %>
                  </td>
                  <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900"><%= event.incoming_event_actions.count %></td>
                  <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500"><%= time_ago_in_words(event.created_at) %> ago</td>
                  <td class="px-3 py-4 whitespace-nowrap text-sm">
                    <%= render FlatPack::Button::Component.new(
                      text: "View",
                      url: url_for([:admin, event]),
                      style: :secondary,
                      size: :sm
                    ) %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p class="text-gray-500">No events received yet.</p>
      <% end %>
    </div>
  </div>
</div>
