<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <%= render FlatPack::Breadcrumb::Component.new(class: "mb-6") do |breadcrumb| %>
    <% breadcrumb.item(text: "Providers", href: admin_providers_path) %>
    <% breadcrumb.item(text: @registry_config&.display_name || @provider.name.titleize) %>
  <% end %>

  <div class="flex justify-between items-center mb-4">
    <h1 class="text-3xl font-bold"><%= @registry_config&.display_name || @provider.name.titleize %></h1>
    <div>
      <%= render FlatPack::Button::Component.new(
        text: "View Actions",
        url: admin_provider_actions_path(@provider),
        style: :secondary
      ) %>
    </div>
  </div>

  <!-- Status Badge -->
  <div class="mb-6">
    <% if @provider.active? %>
      <%= render FlatPack::Badge::Component.new(text: "Active", style: :success, size: :md) %>
    <% else %>
      <%= render FlatPack::Badge::Component.new(text: "Inactive", style: :default, size: :md) %>
    <% end %>
  </div>

  <!-- Webhook URL Card -->
  <div class="bg-white shadow rounded-lg mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900">Webhook Endpoint</h2>
    </div>
    <div class="px-6 py-4">
      <p class="text-gray-600 mb-3">Share this URL with <%= @registry_config&.display_name || @provider.name.titleize %> to receive webhooks:</p>
      <div class="flex gap-2 items-start" data-controller="webhook-copy">
        <div class="flex-1">
          <%= render FlatPack::TextInput::Component.new(
            name: "webhook_url",
            value: @provider.webhook_url(base_url: "#{request.protocol}#{request.host_with_port}"),
            readonly: true,
            class: "font-mono",
            data: { webhook_copy_target: "input" }
          ) %>
        </div>
        <%= render FlatPack::Button::Component.new(
          text: "üìã Copy",
          style: :primary,
          data: { action: "click->webhook-copy#copy" }
        ) %>
      </div>
      <p class="text-sm text-gray-500 mt-3">
        This URL is unique to this provider and includes a secure token for authentication.
      </p>
    </div>
  </div>

  <!-- Provider Details -->
  <div class="bg-white shadow rounded-lg mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900">Provider Details</h2>
    </div>
    <div class="px-6 py-4">
      <dl class="grid grid-cols-1 gap-4">
        <div class="grid grid-cols-3 gap-4">
          <dt class="text-sm font-medium text-gray-500">Name</dt>
          <dd class="col-span-2 text-sm text-gray-900"><code class="px-2 py-1 bg-gray-100 rounded"><%= @provider.name %></code></dd>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <dt class="text-sm font-medium text-gray-500">Display Name</dt>
          <dd class="col-span-2 text-sm text-gray-900">
            <% if @registry_config&.display_name.present? %>
              <%= @registry_config.display_name %>
            <% else %>
              ‚Äî
            <% end %>
          </dd>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <dt class="text-sm font-medium text-gray-500">Description</dt>
          <dd class="col-span-2 text-sm text-gray-900">
            <% if @registry_config&.description.present? %>
              <%= @registry_config.description %>
            <% else %>
              ‚Äî
            <% end %>
          </dd>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <dt class="text-sm font-medium text-gray-500">Verifier File</dt>
          <dd class="col-span-2 text-sm text-gray-900">
            <% if @registry_config&.verifier_file.present? %>
              <code class="px-2 py-1 bg-gray-100 rounded"><%= @registry_config.verifier_file %></code>
            <% else %>
              ‚Äî
            <% end %>
          </dd>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <dt class="text-sm font-medium text-gray-500">Signing Secret</dt>
          <dd class="col-span-2 text-sm text-gray-900">
            <% if @registry_config&.signing_secret.present? %>
              <%= render FlatPack::Badge::Component.new(text: "Configured", style: :success, size: :sm) %>
            <% else %>
              <%= render FlatPack::Badge::Component.new(text: "Not Set", style: :default, size: :sm) %>
              <div class="text-sm text-gray-500 mt-1">
                ‚ö†Ô∏è Some providers don't require a signing secret, but if this provider supports webhook signature verification, you should configure one for security.
              </div>
            <% end %>
          </dd>
        </div>
      </dl>
    </div>
  </div>

  <!-- Security Settings -->
  <!-- Configuration hierarchy: captain_hook.yml providers ‚Üí provider.yml ‚Üí captain_hook.yml defaults ‚Üí hardcoded -->
  <div class="bg-white shadow rounded-lg mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900">Security Settings</h2>
    </div>
    <div class="px-6 py-4">
      <dl class="grid grid-cols-1 gap-4">
        <% 
          # Get values from different sources
          provider_name = @provider.name
          
          # timestamp_tolerance_seconds
          global_override_timestamp = @global_config&.dig("providers", provider_name, "timestamp_tolerance_seconds")
          provider_yaml_timestamp = @provider_yaml&.dig("timestamp_tolerance_seconds")
          global_default_timestamp = @global_config&.dig("defaults", "timestamp_tolerance_seconds")
          hardcoded_timestamp = 300
          
          final_timestamp = global_override_timestamp || provider_yaml_timestamp || global_default_timestamp || hardcoded_timestamp
          
          # max_payload_size_bytes
          global_override_size = @global_config&.dig("providers", provider_name, "max_payload_size_bytes")
          provider_yaml_size = @provider_yaml&.dig("max_payload_size_bytes")
          global_default_size = @global_config&.dig("defaults", "max_payload_size_bytes")
          hardcoded_size = 1_048_576
          
          final_size = global_override_size || provider_yaml_size || global_default_size || hardcoded_size
          
          # rate_limit_requests
          db_rate_requests = @provider.rate_limit_requests
          provider_yaml_rate_requests = @provider_yaml&.dig("rate_limit_requests")
          hardcoded_rate_requests = 100
          
          final_rate_requests = db_rate_requests || provider_yaml_rate_requests || hardcoded_rate_requests
          
          # rate_limit_period
          db_rate_period = @provider.rate_limit_period
          provider_yaml_rate_period = @provider_yaml&.dig("rate_limit_period")
          hardcoded_rate_period = 60
          
          final_rate_period = db_rate_period || provider_yaml_rate_period || hardcoded_rate_period
        %>
        
        <div class="grid grid-cols-3 gap-4">
          <dt class="text-sm font-medium text-gray-500">timestamp_tolerance_seconds</dt>
          <dd class="col-span-2 text-sm text-gray-900">
            <%= final_timestamp %>
            <% if global_override_timestamp %>
              <%= render FlatPack::Badge::Component.new(text: "captain_hook.yml providers", style: :success, size: :sm, class: "ml-2") %>
            <% elsif provider_yaml_timestamp %>
              <%= render FlatPack::Badge::Component.new(text: "#{provider_name}.yml", style: :info, size: :sm, class: "ml-2") %>
            <% elsif global_default_timestamp %>
              <%= render FlatPack::Badge::Component.new(text: "captain_hook.yml defaults", style: :default, size: :sm, class: "ml-2") %>
            <% else %>
              <%= render FlatPack::Badge::Component.new(text: "hardcoded", style: :default, size: :sm, class: "ml-2") %>
            <% end %>
            <span class="text-gray-500">(¬±<%= final_timestamp %>s tolerance)</span>
          </dd>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <dt class="text-sm font-medium text-gray-500">max_payload_size_bytes</dt>
          <dd class="col-span-2 text-sm text-gray-900">
            <%= number_with_delimiter(final_size) %>
            <% if global_override_size %>
              <%= render FlatPack::Badge::Component.new(text: "captain_hook.yml providers", style: :success, size: :sm, class: "ml-2") %>
            <% elsif provider_yaml_size %>
              <%= render FlatPack::Badge::Component.new(text: "#{provider_name}.yml", style: :info, size: :sm, class: "ml-2") %>
            <% elsif global_default_size %>
              <%= render FlatPack::Badge::Component.new(text: "captain_hook.yml defaults", style: :default, size: :sm, class: "ml-2") %>
            <% else %>
              <%= render FlatPack::Badge::Component.new(text: "hardcoded", style: :default, size: :sm, class: "ml-2") %>
            <% end %>
            <span class="text-gray-500">(<%= number_to_human_size(final_size) %>)</span>
          </dd>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <dt class="text-sm font-medium text-gray-500">rate_limit_requests</dt>
          <dd class="col-span-2 text-sm text-gray-900">
            <%= final_rate_requests %>
            <% if db_rate_requests %>
              <%= render FlatPack::Badge::Component.new(text: "database", style: :warning, size: :sm, class: "ml-2") %>
            <% elsif provider_yaml_rate_requests %>
              <%= render FlatPack::Badge::Component.new(text: "#{provider_name}.yml", style: :info, size: :sm, class: "ml-2") %>
            <% else %>
              <%= render FlatPack::Badge::Component.new(text: "hardcoded", style: :default, size: :sm, class: "ml-2") %>
            <% end %>
            <span class="text-gray-500">(requests)</span>
          </dd>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <dt class="text-sm font-medium text-gray-500">rate_limit_period</dt>
          <dd class="col-span-2 text-sm text-gray-900">
            <%= final_rate_period %>
            <% if db_rate_period %>
              <%= render FlatPack::Badge::Component.new(text: "database", style: :warning, size: :sm, class: "ml-2") %>
            <% elsif provider_yaml_rate_period %>
              <%= render FlatPack::Badge::Component.new(text: "#{provider_name}.yml", style: :info, size: :sm, class: "ml-2") %>
            <% else %>
              <%= render FlatPack::Badge::Component.new(text: "hardcoded", style: :default, size: :sm, class: "ml-2") %>
            <% end %>
            <span class="text-gray-500">(seconds)</span>
          </dd>
        </div>
      </dl>
    </div>
  </div>

  <!-- Recent Events -->
  <div class="bg-white shadow rounded-lg">
    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
      <h2 class="text-lg font-semibold text-gray-900">Recent Events</h2>
      <%= render FlatPack::Button::Component.new(
        text: "View All",
        url: admin_incoming_events_path(provider: @provider.name),
        style: :secondary,
        size: :sm
      ) %>
    </div>
    <div class="px-6 py-4">
      <% if @recent_events.any? %>
        <%= render FlatPack::Table::Component.new(data: @recent_events) do |table| %>
          <% table.column(title: "Event Type", html: ->(event) {
            "<code class=\"px-2 py-1 bg-gray-100 rounded text-xs\">#{event.event_type}</code>".html_safe
          }) %>
          
          <% table.column(title: "Status", html: ->(event) {
            status_variant = case event.status&.to_s
            when "pending" then :warning
            when "processing" then :info
            when "completed", "sent" then :success
            when "failed" then :warning
            else :default
            end
            render(FlatPack::Badge::Component.new(text: event.status&.titleize || 'N/A', style: status_variant, size: :sm))
          }) %>
          
          <% table.column(title: "Actions", html: ->(event) { event.incoming_event_actions.count.to_s }) %>
          
          <% table.column(title: "Received", html: ->(event) {
            "#{time_ago_in_words(event.created_at)} ago"
          }) %>
          
          <% table.with_action(
            text: "View",
            url: ->(event) { url_for([:admin, event]) },
            style: :secondary,
            size: :sm
          ) %>
        <% end %>
      <% else %>
        <p class="text-gray-500">No events received yet.</p>
      <% end %>
    </div>
  </div>
</div>
