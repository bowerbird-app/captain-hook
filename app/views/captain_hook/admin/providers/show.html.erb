<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <nav aria-label="breadcrumb" class="mb-6">
    <ol class="flex items-center space-x-2 text-sm">
      <li>
        <%= link_to "Providers", admin_providers_path, class: "text-gray-600 hover:text-gray-900 hover:underline" %>
      </li>
      <li class="text-gray-400">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
      </li>
      <li class="font-medium text-gray-900">
        <%= @registry_config&.display_name || @provider.name.titleize %>
      </li>
    </ol>
  </nav>

  <div class="flex justify-between items-center mb-4">
    <h1 class="text-3xl font-bold"><%= @registry_config&.display_name || @provider.name.titleize %></h1>
    <div>
      <%= render FlatPack::Button::Component.new(
        text: "View Actions",
        url: admin_provider_actions_path(@provider),
        style: :secondary
      ) %>
    </div>
  </div>

  <!-- Status Badge -->
  <div class="mb-4">
    <% if @provider.active? %>
      <%= badge("Active", color: "green") %>
    <% else %>
      <%= badge("Inactive", color: "gray") %>
    <% end %>
  </div>

  <!-- Webhook URL Card -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Webhook Endpoint</h5>
    </div>
    <div class="card-body">
      <p class="text-muted mb-2">Share this URL with <%= @registry_config&.display_name || @provider.name.titleize %> to receive webhooks:</p>
      <div class="flex gap-2" data-controller="webhook-copy">
        <input type="text" class="flex-1 px-3 py-2 border border-[var(--color-border)] rounded-[var(--radius-md)] font-mono text-sm bg-[var(--color-muted)]" data-webhook-copy-target="input" value="<%= @provider.webhook_url(base_url: "#{request.protocol}#{request.host_with_port}") %>" readonly>
        <button type="button" data-action="click->webhook-copy#copy" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
          üìã Copy
        </button>
      </div>
      <small class="text-muted d-block mt-2">
        This URL is unique to this provider and includes a secure token for authentication.
      </small>
    </div>
  </div>

  <!-- Provider Details -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Provider Details</h5>
    </div>
    <div class="card-body">
      <dl class="row">
        <dt class="col-sm-3">Name</dt>
        <dd class="col-sm-9"><code><%= @provider.name %></code></dd>

        <dt class="col-sm-3">Display Name</dt>
        <dd class="col-sm-9">
          <% if @registry_config&.display_name.present? %>
            <%= @registry_config.display_name %>
          <% else %>
            ‚Äî
          <% end %>
        </dd>

        <dt class="col-sm-3">Description</dt>
        <dd class="col-sm-9">
          <% if @registry_config&.description.present? %>
            <%= @registry_config.description %>
          <% else %>
            ‚Äî
          <% end %>
        </dd>

        <dt class="col-sm-3">Verifier File</dt>
        <dd class="col-sm-9">
          <% if @registry_config&.verifier_file.present? %>
            <code><%= @registry_config.verifier_file %></code>
          <% else %>
            ‚Äî
          <% end %>
        </dd>

        <dt class="col-sm-3">Signing Secret</dt>
        <dd class="col-sm-9">
          <% if @registry_config&.signing_secret.present? %>
            <%= badge("Configured", color: "green") %>
          <% else %>
            <%= badge("Not Set", color: "gray") %>
            <div class="text-muted small mt-1">
              ‚ö†Ô∏è Some providers don't require a signing secret, but if this provider supports webhook signature verification, you should configure one for security.
            </div>
          <% end %>
        </dd>
      </dl>
    </div>
  </div>

  <!-- Security Settings -->
  <!-- Configuration hierarchy: captain_hook.yml providers ‚Üí provider.yml ‚Üí captain_hook.yml defaults ‚Üí hardcoded -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Security Settings</h5>
    </div>
    <div class="card-body">
      <dl class="row">
        <% 
          # Get values from different sources
          provider_name = @provider.name
          
          # timestamp_tolerance_seconds
          global_override_timestamp = @global_config&.dig("providers", provider_name, "timestamp_tolerance_seconds")
          provider_yaml_timestamp = @provider_yaml&.dig("timestamp_tolerance_seconds")
          global_default_timestamp = @global_config&.dig("defaults", "timestamp_tolerance_seconds")
          hardcoded_timestamp = 300
          
          final_timestamp = global_override_timestamp || provider_yaml_timestamp || global_default_timestamp || hardcoded_timestamp
          
          # max_payload_size_bytes
          global_override_size = @global_config&.dig("providers", provider_name, "max_payload_size_bytes")
          provider_yaml_size = @provider_yaml&.dig("max_payload_size_bytes")
          global_default_size = @global_config&.dig("defaults", "max_payload_size_bytes")
          hardcoded_size = 1_048_576
          
          final_size = global_override_size || provider_yaml_size || global_default_size || hardcoded_size
          
          # rate_limit_requests
          db_rate_requests = @provider.rate_limit_requests
          provider_yaml_rate_requests = @provider_yaml&.dig("rate_limit_requests")
          hardcoded_rate_requests = 100
          
          final_rate_requests = db_rate_requests || provider_yaml_rate_requests || hardcoded_rate_requests
          
          # rate_limit_period
          db_rate_period = @provider.rate_limit_period
          provider_yaml_rate_period = @provider_yaml&.dig("rate_limit_period")
          hardcoded_rate_period = 60
          
          final_rate_period = db_rate_period || provider_yaml_rate_period || hardcoded_rate_period
        %>
        
        <dt class="col-sm-4">timestamp_tolerance_seconds</dt>
        <dd class="col-sm-8">
          <%= final_timestamp %>
          <% if global_override_timestamp %>
            <%= badge("captain_hook.yml providers", color: "blue", class: "ml-2") %>
          <% elsif provider_yaml_timestamp %>
            <%= badge("#{provider_name}.yml", color: "blue", class: "ml-2") %>
          <% elsif global_default_timestamp %>
            <%= badge("captain_hook.yml defaults", color: "gray", class: "ml-2") %>
          <% else %>
            <%= badge("hardcoded", color: "gray", class: "ml-2") %>
          <% end %>
          <small class="text-muted">(¬±<%= final_timestamp %>s tolerance)</small>
        </dd>

        <dt class="col-sm-4">max_payload_size_bytes</dt>
        <dd class="col-sm-8">
          <%= number_with_delimiter(final_size) %>
          <% if global_override_size %>
            <%= badge("captain_hook.yml providers", color: "blue", class: "ml-2") %>
          <% elsif provider_yaml_size %>
            <%= badge("#{provider_name}.yml", color: "blue", class: "ml-2") %>
          <% elsif global_default_size %>
            <%= badge("captain_hook.yml defaults", color: "gray", class: "ml-2") %>
          <% else %>
            <%= badge("hardcoded", color: "gray", class: "ml-2") %>
          <% end %>
          <small class="text-muted">(<%= number_to_human_size(final_size) %>)</small>
        </dd>

        <dt class="col-sm-4">rate_limit_requests</dt>
        <dd class="col-sm-8">
          <%= final_rate_requests %>
          <% if db_rate_requests %>
            <%= badge("database", color: "yellow", class: "ml-2") %>
          <% elsif provider_yaml_rate_requests %>
            <%= badge("#{provider_name}.yml", color: "blue", class: "ml-2") %>
          <% else %>
            <%= badge("hardcoded", color: "gray", class: "ml-2") %>
          <% end %>
          <small class="text-muted">(requests)</small>
        </dd>

        <dt class="col-sm-4">rate_limit_period</dt>
        <dd class="col-sm-8">
          <%= final_rate_period %>
          <% if db_rate_period %>
            <%= badge("database", color: "yellow", class: "ml-2") %>
          <% elsif provider_yaml_rate_period %>
            <%= badge("#{provider_name}.yml", color: "blue", class: "ml-2") %>
          <% else %>
            <%= badge("hardcoded", color: "gray", class: "ml-2") %>
          <% end %>
          <small class="text-muted">(seconds)</small>
        </dd>
      </dl>
    </div>
  </div>

  <!-- Recent Events -->
  <div class="card">
    <div class="card-header flex justify-between items-center">
      <h5 class="mb-0">Recent Events</h5>
      <%= render FlatPack::Button::Component.new(
        text: "View All",
        url: admin_incoming_events_path(provider: @provider.name),
        style: :secondary,
        size: :sm
      ) %>
    </div>
    <div class="card-body">
      <% if @recent_events.any? %>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Event Type</th>
                <th>Status</th>
                <th>Actions</th>
                <th>Received</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @recent_events.each do |event| %>
                <tr>
                  <td><code><%= event.event_type %></code></td>
                  <td>
                    <%= badge(event.status&.titleize || 'N/A', color: status_color(event.status)) %>
                  </td>
                  <td><%= event.incoming_event_actions.count %></td>
                  <td><%= time_ago_in_words(event.created_at) %> ago</td>
                  <td>
                    <%= render FlatPack::Button::Component.new(
                      text: "View",
                      url: url_for([:admin, event]),
                      style: :secondary,
                      size: :sm
                    ) %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p class="text-muted mb-0">No events received yet.</p>
      <% end %>
    </div>
  </div>
</div>
