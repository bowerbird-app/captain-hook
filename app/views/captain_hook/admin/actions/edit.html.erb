<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <%= render FlatPack::Breadcrumb::Component.new(class: "mb-6") do |breadcrumb| %>
    <% breadcrumb.item(text: "Providers", href: admin_providers_path) %>
    <% breadcrumb.item(text: @registry_config&.display_name || @provider.name.titleize, href: admin_provider_path(@provider)) %>
    <% breadcrumb.item(text: "Actions", href: admin_provider_actions_path(@provider)) %>
    <% breadcrumb.item(text: "Edit") %>
  <% end %>

  <h1 class="text-3xl font-bold text-gray-900 mb-6">Edit Action</h1>

  <%= render FlatPack::Card::Component.new(style: :elevated) do |card| %>
    <% card.body do %>
      <%= form_with(model: @action, url: admin_provider_action_path(@provider, @action), method: :patch, local: true) do |f| %>
        <% if @action.errors.any? %>
          <div class="bg-red-50 border border-red-200 rounded-lg px-6 py-4 mb-6">
            <h5 class="font-semibold text-red-900 mb-2"><%= pluralize(@action.errors.count, "error") %> prohibited this action from being saved:</h5>
            <ul class="list-disc list-inside text-red-800 space-y-1">
              <% @action.errors.each do |error| %>
                <li><%= error.full_message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <!-- Read-only fields -->
        <div class="space-y-6">
          <div>
            <%= render FlatPack::TextInput::Component.new(
              name: "provider_name",
              label: "Provider",
              value: @provider.name,
              disabled: true
            ) %>
            <p class="text-xs text-gray-500 mt-2">Provider cannot be changed</p>
          </div>

          <div>
            <%= render FlatPack::TextInput::Component.new(
              name: "action_class",
              label: "Action Class",
              value: @action.action_class,
              disabled: true
            ) %>
            <p class="text-xs text-gray-500 mt-2">Action class cannot be changed</p>
          </div>

          <!-- Event Type -->
          <div>
            <%= render FlatPack::TextInput::Component.new(
              name: "captain_hook_action[event_type]",
              label: "Event Type",
              value: @action.event_type
            ) %>
            <p class="text-xs text-gray-500 mt-2">The webhook event type this action processes (e.g., "payment.succeeded")</p>
          </div>

          <!-- Async/Sync Toggle -->
          <div>
            <%= render FlatPack::RadioGroup::Component.new(
              name: "captain_hook_action[async]",
              label: "Execution Mode",
              options: [
                ["Async (Run in background job)", "true"],
                ["Sync (Run immediately in request)", "false"]
              ],
              value: @action.async.to_s
            ) %>
            <p class="text-xs text-gray-500 mt-2">
              <strong>Async:</strong> Action runs in a background job (recommended for most cases)<br>
              <strong>Sync:</strong> Action runs immediately in the webhook request (only for fast actions)
            </p>
          </div>

          <!-- Priority -->
          <div>
            <%= render FlatPack::NumberInput::Component.new(
              name: "captain_hook_action[priority]",
              label: "Priority",
              value: @action.priority
            ) %>
            <p class="text-xs text-gray-500 mt-2">Lower numbers execute first (e.g., 10 runs before 100)</p>
          </div>

          <!-- Max Attempts -->
          <div>
            <%= render FlatPack::NumberInput::Component.new(
              name: "captain_hook_action[max_attempts]",
              label: "Maximum Retry Attempts",
              value: @action.max_attempts,
              min: 1
            ) %>
            <p class="text-xs text-gray-500 mt-2">Number of times to retry on failure (minimum 1)</p>
          </div>

          <!-- Retry Delays -->
          <div>
            <%= render FlatPack::TextInput::Component.new(
              name: "captain_hook_action[retry_delays]",
              label: "Retry Delays (seconds)",
              value: @action.retry_delays.join(", "),
              placeholder: "30, 60, 300, 900, 3600",
              id: "action_retry_delays"
            ) %>
            <p class="text-xs text-gray-500 mt-2">
              Comma-separated list of delay times in seconds between retries.<br>
              Example: <code class="bg-gray-100 px-1 py-0.5 rounded">30, 60, 300, 900, 3600</code> means wait 30s, then 60s, then 5min, then 15min, then 1hr between retries.
            </p>
          </div>
        </div>

        <div class="flex justify-between items-center pt-6 border-t border-gray-200">
          <%= render FlatPack::Button::Component.new(
            text: "Update Action",
            style: :primary,
            type: "submit"
          ) %>
          <%= render FlatPack::Button::Component.new(
            text: "Cancel",
            url: admin_provider_actions_path(@provider),
            style: :secondary
          ) %>
        </div>
      <% end %>
    <% end %>
  <% end %>

  <!-- Danger Zone -->
  <%= render FlatPack::Card::Component.new(style: :outlined, class: "mt-6 border-2 border-red-200") do |card| %>
    <% card.header(divider: true) do %>
      <div class="bg-red-50 -mx-6 -my-4 px-6 py-4">
        <h5 class="font-semibold text-red-900">Danger Zone</h5>
      </div>
    <% end %>
    <% card.body do %>
      <h6 class="font-medium text-gray-900 mb-2">Delete Action</h6>
      <p class="text-gray-600 mb-4">
        Soft-deleting this action will prevent it from being re-added during future scans.
        The action will remain in the database but marked as deleted.
      </p>
      <%= button_to "Delete Action", 
                    admin_provider_action_path(@provider, @action), 
                    method: :delete, 
                    class: "px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-md transition-colors cursor-pointer",
                    form: { data: { turbo_confirm: "Are you sure you want to delete this action? It will be skipped during future scans." } } %>
    <% end %>
  <% end %>
</div>

<script>
// Parse retry_delays before form submission
document.addEventListener('DOMContentLoaded', function() {
  const form = document.querySelector('form');
  const retryDelaysInput = document.querySelector('#action_retry_delays');
  
  form.addEventListener('submit', function(e) {
    // Convert comma-separated string to JSON array
    const delaysString = retryDelaysInput.value;
    const delaysArray = delaysString.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
    
    // Create a hidden field with JSON array
    const hiddenField = document.createElement('input');
    hiddenField.type = 'hidden';
    hiddenField.name = 'captain_hook_action[retry_delays]';
    hiddenField.value = JSON.stringify(delaysArray);
    
    form.appendChild(hiddenField);
    
    // Remove the original field from submission
    retryDelaysInput.disabled = true;
  });
});
</script>
