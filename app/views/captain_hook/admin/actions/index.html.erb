<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <nav aria-label="breadcrumb" class="mb-6">
    <ol class="flex items-center space-x-2 text-sm">
      <li>
        <%= link_to "Providers", admin_providers_path, class: "text-gray-600 hover:text-gray-900 hover:underline" %>
      </li>
      <li class="text-gray-400">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
      </li>
      <li>
        <%= link_to @registry_config&.display_name || @provider.name.titleize, [:admin, @provider], class: "text-gray-600 hover:text-gray-900 hover:underline" %>
      </li>
      <li class="text-gray-400">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
      </li>
      <li class="font-medium text-gray-900">Actions</li>
    </ol>
  </nav>

  <% if @db_actions.any? %>
    <div class="bg-white shadow rounded-lg mb-6">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900">Actions</h2>
      </div>
      <div class="px-6 py-4">
        <%= render FlatPack::Table::Component.new(data: @db_actions) do |table| %>
          <% table.column(title: "Action", html: ->(action) {
            "<code class=\"px-2 py-1 bg-gray-100 rounded text-xs\">#{action.action_class}</code>".html_safe
          }) %>
          
          <% table.column(title: "Event", html: ->(action) {
            "<code class=\"px-2 py-1 bg-gray-100 rounded text-xs\">#{action.event_type}</code>".html_safe
          }) %>
          
          <% table.column(title: "Incoming Events", html: ->(action) {
            event_count = CaptainHook::IncomingEvent.where(provider: @provider.name, event_type: action.event_type).count
            link_to(event_count.to_s, admin_incoming_events_path(provider: @provider.name, event_type: action.event_type))
          }) %>
          
          <% table.with_action(
            text: "Edit",
            url: ->(action) { edit_admin_provider_action_path(@provider, action) },
            style: :secondary
          ) %>
        <% end %>
      </div>
    </div>
  <% end %>

  <% 
    # Find registry actions that are NOT in the database
    unsynced_actions = {}
    @registry_actions.each do |event_type, action_configs|
      action_configs.each do |config|
        # Check if this action exists in DB
        db_match = @db_actions.find { |h| h.event_type == event_type && h.action_class == config.action_class }
        unless db_match
          unsynced_actions[event_type] ||= []
          unsynced_actions[event_type] << config
        end
      end
    end
  %>
  
  <% if unsynced_actions.any? %>
    <div class="bg-white shadow rounded-lg mb-6">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900">Registered Actions (In-Memory Registry)</h2>
      </div>
      <div class="px-6 py-4">
        <p class="text-gray-600 mb-4">
          These actions are registered in your application code but not yet synced to the database.
          They will be automatically synced on the next application restart.
        </p>
        
        <% unsynced_actions.each do |event_type, action_configs| %>
          <div class="mb-6">
            <h3 class="text-md font-semibold border-b border-gray-200 pb-2 mb-3">
              Event Type: <code class="px-2 py-1 bg-gray-100 rounded text-xs"><%= event_type %></code>
            </h3>
            <%= render FlatPack::Table::Component.new(data: action_configs) do |table| %>
              <% table.column(title: "Priority", html: ->(config) {
                render(FlatPack::Badge::Component.new(text: config.priority.to_s, style: :default, size: :sm))
              }) %>
              
              <% table.column(title: "Action Class", html: ->(config) {
                "<code class=\"px-2 py-1 bg-gray-100 rounded text-xs\">#{config.action_class}</code>".html_safe
              }) %>
              
              <% table.column(title: "Execution", html: ->(config) {
                if config.async
                  render(FlatPack::Badge::Component.new(text: "Async", style: :info, size: :sm))
                else
                  render(FlatPack::Badge::Component.new(text: "Sync", style: :warning, size: :sm))
                end
              }) %>
              
              <% table.column(title: "Max Attempts", html: ->(config) { config.max_attempts.to_s }) %>
              
              <% table.column(title: "Retry Delays", html: ->(config) {
                "<span class=\"text-xs text-gray-600\">#{config.retry_delays.join(', ')}s</span>".html_safe
              }) %>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <% if @db_actions.empty? && @registry_actions.empty? %>
    <div class="bg-white shadow rounded-lg">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900">No actions registered</h2>
      </div>
      <div class="px-6 py-4">
        <p class="text-gray-600 mb-2">
          You haven't registered any actions for this provider yet.
          Actions are registered in your application code, typically in an initializer.
        </p>
        <p class="text-gray-900 font-medium mb-2">
          To register an action:
        </p>
        <ol class="list-decimal list-inside space-y-1 text-gray-600">
          <li>Create an action class (e.g., <code class="px-2 py-1 bg-gray-100 rounded text-xs">app/actions/my_action.rb</code>)</li>
          <li>Register it in <code class="px-2 py-1 bg-gray-100 rounded text-xs">config/initializers/captain_hook.rb</code></li>
          <li>Restart your application to trigger auto-discovery</li>
        </ol>
      </div>
    </div>
  <% end %>
</div>
