<div class="container py-4">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><%= link_to "Providers", admin_providers_path %></li>
      <li class="breadcrumb-item"><%= link_to @registry_config&.display_name || @provider.name.titleize, [:admin, @provider] %></li>
      <li class="breadcrumb-item active" aria-current="page">Actions</li>
    </ol>
  </nav>

  <% if @db_actions.any? %>
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Actions</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Action</th>
                <th>Event</th>
                <th>Incoming Events</th>
                <th>Edit</th>
              </tr>
            </thead>
            <tbody>
              <% @db_actions.each do |action| %>
                <% event_count = CaptainHook::IncomingEvent.where(provider: @provider.name, event_type: action.event_type).count %>
                <tr>
                  <td><code><%= action.action_class %></code></td>
                  <td><code><%= action.event_type %></code></td>
                  <td>
                    <%= link_to admin_incoming_events_path(provider: @provider.name, event_type: action.event_type) do %>
                      <%= event_count %>
                    <% end %>
                  </td>
                  <td>
                    <%= link_to "Edit", edit_admin_provider_action_path(@provider, action), class: "btn btn-sm btn-outline-primary" %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  <% end %>

  <% 
    # Find registry actions that are NOT in the database
    unsynced_actions = {}
    @registry_actions.each do |event_type, action_configs|
      action_configs.each do |config|
        # Check if this action exists in DB
        db_match = @db_actions.find { |h| h.event_type == event_type && h.action_class == config.action_class }
        unless db_match
          unsynced_actions[event_type] ||= []
          unsynced_actions[event_type] << config
        end
      end
    end
  %>
  
  <% if unsynced_actions.any? %>
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Registered Actions (In-Memory Registry)</h5>
      </div>
      <div class="card-body">
        <p class="text-muted">
          These actions are registered in your application code but not yet synced to the database.
          They will be automatically synced on the next application restart.
        </p>
        
        <% unsynced_actions.each do |event_type, action_configs| %>
          <div class="mb-4">
            <h6 class="border-bottom pb-2">
              Event Type: <code><%= event_type %></code>
            </h6>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Priority</th>
                    <th>Action Class</th>
                    <th>Execution</th>
                    <th>Max Attempts</th>
                    <th>Retry Delays</th>
                  </tr>
                </thead>
                <tbody>
                  <% action_configs.each do |config| %>
                    <tr>
                      <td><span class="badge bg-secondary"><%= config.priority %></span></td>
                      <td><code><%= config.action_class %></code></td>
                      <td>
                        <% if config.async %>
                          <span class="badge bg-info">Async</span>
                        <% else %>
                          <span class="badge bg-warning">Sync</span>
                        <% end %>
                      </td>
                      <td><%= config.max_attempts %></td>
                      <td><small><%= config.retry_delays.join(", ") %>s</small></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <% if @db_actions.empty? && @registry_actions.empty? %>
    <div class="alert alert-info">
      <h5>No actions registered</h5>
      <p class="mb-2">
        You haven't registered any actions for this provider yet.
        Actions are registered in your application code, typically in an initializer.
      </p>
      <p class="mb-0">
        <strong>To register an action:</strong>
      </p>
      <ol class="mt-2">
        <li>Create an action class (e.g., <code>app/actions/my_action.rb</code>)</li>
        <li>Register it in <code>config/initializers/captain_hook.rb</code></li>
        <li>Restart your application to trigger auto-discovery</li>
      </ol>
    </div>
  <% end %>
</div>
