name: Security Scan

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  brakeman:
    name: Brakeman Security Scanner
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Install Brakeman
        run: gem install brakeman

      - name: Run Brakeman scan
        run: |
          brakeman --format json --output brakeman-report.json --no-pager --no-exit-on-warn --no-exit-on-error || true
          brakeman --format markdown --output brakeman-report.md --no-pager || true

      - name: Display Brakeman results
        run: |
          echo "## Brakeman Security Scan Results" >> $GITHUB_STEP_SUMMARY
          if [ -f brakeman-report.md ]; then
            cat brakeman-report.md >> $GITHUB_STEP_SUMMARY
          else
            echo "No security issues found! âœ…" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for high/medium severity issues
        run: |
          if [ -f brakeman-report.json ]; then
            HIGH=$(jq '.warnings | map(select(.confidence == "High")) | length' brakeman-report.json)
            MEDIUM=$(jq '.warnings | map(select(.confidence == "Medium")) | length' brakeman-report.json)
            TOTAL=$(jq '.warnings | length' brakeman-report.json)
            
            echo "Security Scan Summary:"
            echo "  Total Warnings: $TOTAL"
            echo "  High Confidence: $HIGH"
            echo "  Medium Confidence: $MEDIUM"
            
            if [ "$HIGH" -gt "0" ]; then
              echo "âŒ High confidence security issues detected!"
              exit 1
            fi
            
            if [ "$MEDIUM" -gt "3" ]; then
              echo "âš ï¸  Too many medium confidence security issues detected!"
              exit 1
            fi
            
            echo "âœ… Security scan passed!"
          fi

      - name: Upload Brakeman report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: brakeman-report
          path: |
            brakeman-report.json
            brakeman-report.md
          retention-days: 30

  bundler-audit:
    name: Bundler Audit (Dependency Check)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Install bundler-audit
        run: gem install bundler-audit

      - name: Update vulnerability database
        run: bundler-audit update

      - name: Run bundler-audit
        run: bundler-audit check --verbose

  rubocop-security:
    name: RuboCop Security
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Install RuboCop
        run: |
          gem install rubocop
          gem install rubocop-rails

      - name: Run RuboCop Security checks
        run: |
          rubocop --only Security --format json --out rubocop-security.json || true
          rubocop --only Security --format markdown --out rubocop-security.md || true
          rubocop --only Security

      - name: Display RuboCop Security results
        if: always()
        run: |
          if [ -f rubocop-security.md ]; then
            echo "## RuboCop Security Results" >> $GITHUB_STEP_SUMMARY
            cat rubocop-security.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload RuboCop report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rubocop-security-report
          path: |
            rubocop-security.json
            rubocop-security.md
          retention-days: 30

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [brakeman, bundler-audit, rubocop-security]
    if: always()
    
    steps:
      - name: Create security summary
        run: |
          echo "# ðŸ”’ Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All security checks have been completed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Brakeman (Rails Security Scanner)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Bundler Audit (Dependency Vulnerabilities)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… RuboCop Security (Code Security Patterns)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the individual job outputs for detailed results." >> $GITHUB_STEP_SUMMARY
